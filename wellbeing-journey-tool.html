<script>
document.getElementById('downloadPdfBtn').addEventListener('click', function(e){
  e.preventDefault();

  try {
    const { jsPDF } = window.jspdf;

    // Validate quiz completion
    function getAnswers(){
      const answers = [];
      for(let i = 1; i <= 6; i++){
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if(!selected){
          alert("Please complete the quiz before downloading your PDF.");
          return null;
        }
        const question = document.querySelector(`.q[data-q="${i}"] h3`).innerText;
        const answer = selected.parentElement.innerText.trim();
        answers.push({ question, answer });
      }
      return answers;
    }

    const answers = getAnswers();
    if(!answers) return;

    const counts = {A:0,B:0,C:0};
    answers.forEach(a=>{
      if(a.answer.includes('A)')) counts.A++;
      if(a.answer.includes('B)')) counts.B++;
      if(a.answer.includes('C)')) counts.C++;
    });

    const dominant =
      counts.A >= counts.B && counts.A >= counts.C ? 'A' :
      counts.B >= counts.A && counts.B >= counts.C ? 'B' : 'C';

    // Build practical & reflective plan
    const plans = {
      A: {
        title: "Quick Calm & Body Reset",
        overview:
          "Your answers suggest that stress shows up physically for you — tightness, shallow breathing, or feeling on edge. When the body is activated, calm thinking becomes harder.",
        why:
          "Short, physical calming techniques help regulate your nervous system quickly. Once your body settles, your mind follows.",
        steps: [
          "Practice a 3-breath reset: inhale for 4, hold for 2, exhale for 6.",
          "Do a 60-second stretch or shoulder roll when stress spikes.",
          "Pause once daily to notice where your body is holding tension."
        ],
        reflect:
          "Where do I feel stress first in my body, and what helps it soften?"
      },
      B: {
        title: "Emotional Clarity & Reflection",
        overview:
          "Your responses show that stress builds through thoughts, emotions, and mental overwhelm. You benefit from understanding what you’re feeling rather than pushing it away.",
        why:
          "Naming emotions reduces their intensity. When feelings are acknowledged, decision-making becomes clearer and calmer.",
        steps: [
          "Write one sentence daily: “I feel ___ because ___.”",
          "Set a 5-minute reflection window instead of overthinking all day.",
          "Use journaling to release emotions before they pile up."
        ],
        reflect:
          "What emotion have I been avoiding, and what is it trying to tell me?"
      },
      C: {
        title: "Daily Balance & Energy Reset",
        overview:
          "Your answers suggest you keep going even when tired or overloaded. Stress builds quietly until exhaustion sets in.",
        why:
          "Small daily routines prevent burnout and help your energy stay steady instead of crashing.",
        steps: [
          "Choose one 10-minute daily habit (walk, journaling, stretching).",
          "Create a consistent bedtime window.",
          "Schedule one short tech-free pause each day."
        ],
        reflect:
          "What small habit would support me most if I did it consistently?"
      }
    };

    const plan = plans[dominant];

    // Create PDF
    const doc = new jsPDF({ unit: "pt", format: "a4" });
    const left = 40;
    const width = 515;
    let y = 60;

    // Header
    doc.setFontSize(11);
    doc.text("https://emotionalintelligencedeveloper.com/", left, 30);

    // Title
    doc.setFontSize(18);
    doc.text("Your 6-Minute Wellbeing Journey", left, y);
    y += 28;

    doc.setFontSize(12);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, left, y);
    y += 24;

    // Plan section
    doc.setFontSize(14);
    doc.text(plan.title, left, y);
    y += 20;

    doc.setFontSize(11);
    doc.text(doc.splitTextToSize(plan.overview, width), left, y);
    y += 40;

    doc.text("Why this matters:", left, y);
    y += 14;
    doc.text(doc.splitTextToSize(plan.why, width), left, y);
    y += 40;

    doc.setFontSize(12);
    doc.text("Practical steps to try:", left, y);
    y += 16;

    doc.setFontSize(11);
    plan.steps.forEach((step, i)=>{
      const lines = doc.splitTextToSize(`${i+1}. ${step}`, width);
      doc.text(lines, left, y);
      y += lines.length * 14 + 6;
    });

    y += 10;
    doc.setFontSize(12);
    doc.text("Reflection prompt:", left, y);
    y += 14;
    doc.setFontSize(11);
    doc.text(doc.splitTextToSize(plan.reflect, width), left, y);
    y += 30;

    // Answers section
    doc.setFontSize(12);
    doc.text("Your Answers:", left, y);
    y += 16;

    doc.setFontSize(11);
    answers.forEach(a=>{
      doc.text(doc.splitTextToSize(a.question, width), left, y);
      y += 14;
      doc.text(doc.splitTextToSize("Answer: " + a.answer, width), left + 10, y);
      y += 22;
    });

    // Resources
    if (y > 720) { doc.addPage(); y = 60; }

    doc.setFontSize(12);
    doc.text("Helpful Resources:", left, y);
    y += 18;

    doc.setFontSize(11);
    doc.text("• Recommended Books:", left, y);
    y += 14;
    doc.text("https://emotionalintelligencedeveloper.com/recommended-books/", left + 10, y);
    y += 18;

    doc.text("• Help & Support Page:", left, y);
    y += 14;
    doc.text("https://emotionalintelligencedeveloper.com/help-page/", left + 10, y);
    y += 22;

    doc.setFontSize(10);
    doc.text(
      "Some recommended resources may include affiliate links. If you choose to buy, Emotional Intelligence Developer may earn a small commission at no extra cost to you.",
      left,
      y
    );

    // Footer
    doc.setFontSize(10);
    doc.text(
      "Created by Emotional Intelligence Developer — https://emotionalintelligencedeveloper.com/",
      left,
      800
    );

    doc.save(
      "Wellbeing-Journey-" +
      new Date().toISOString().slice(0,19).replace(/[:T]/g,"-") +
      ".pdf"
    );

  } catch(err){
    alert("PDF generation failed. Please try again.");
    console.error(err);
  }
});
</script>
